<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>How to test your Meteor.js web app using Chimp, Cucumber and Jasmine</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">How to test your Meteor.js web app using Chimp, Cucumber and Jasmine</h1>
</header>
<section data-field="subtitle" class="p-summary">
After sharing my struggle in finding the right tools and from-scratch procedures; I provide simple instructions to test your Meteor project…
</section>
<section data-field="body" class="e-content">
<section name="8b1c" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="7e02" id="7e02" class="graf graf--h3 graf--leading graf--title">How to test your Meteor.js web app using Chimp, Cucumber and Jasmine</h3><p name="d720" id="d720" class="graf graf--p graf-after--h3">I feel that automated tests are like teenage sex: developers talk a lot about it, but only few of them actually do it. (at least from the developers I talk with)</p><p name="8de1" id="8de1" class="graf graf--p graf-after--p">Yesterday, while I was integrating a complex login/signup flow on a <a href="https://www.meteor.com/" data-href="https://www.meteor.com/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Meteor.js</a> web app for a client, I felt that this complexity could lead to future bugs. So I decided to write a test to make sure that it won’t fall apart on any future commit.</p><blockquote name="9b6c" id="9b6c" class="graf graf--blockquote graf-after--p"><strong class="markup--strong markup--blockquote-strong">EDIT</strong>: At the time, I was using <strong class="markup--strong markup--blockquote-strong">Chimp v0.24.1</strong>, running on <strong class="markup--strong markup--blockquote-strong">Node v0.12.9</strong>.<br>Be careful, Chimp is evolving a lot, so this tutorial may already be deprecated.</blockquote><p name="01a8" id="01a8" class="graf graf--p graf-after--blockquote">My problems were:</p><ul class="postList"><li name="5ca4" id="5ca4" class="graf graf--li graf-after--p">I have very little experience with automated testing,</li><li name="292e" id="292e" class="graf graf--li graf-after--li">I had never written tests for a Meteor.js app,</li><li name="289d" id="289d" class="graf graf--li graf-after--li">and I was confused about the current best practices (if any) with that technology: <a href="http://xolv.io/blog-posts/2015/11/6/the-seven-testing-modes-of-meteor" data-href="http://xolv.io/blog-posts/2015/11/6/the-seven-testing-modes-of-meteor" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank"><em class="markup--em markup--li-em">What tool should I use</em></a><em class="markup--em markup--li-em">?</em></li></ul><h4 name="484e" id="484e" class="graf graf--h4 graf-after--li">Why did I struggle?</h4><p name="e2cf" id="e2cf" class="graf graf--p graf-after--h4">Apparently MDG had <a href="http://info.meteor.com/blog/meteor-testing-framework-velocity" data-href="http://info.meteor.com/blog/meteor-testing-framework-velocity" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">decided to use Velocity as their standard test driver</a>, but I could not see any reference to testing (besides tinytest for testing packages) in <a href="http://docs.meteor.com/#/full/" data-href="http://docs.meteor.com/#/full/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Meteor.js’ official documentation</a> and <a href="http://guide.meteor.com/" data-href="http://guide.meteor.com/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">guide</a>.</p><p name="16f3" id="16f3" class="graf graf--p graf-after--p">I also read that <a href="https://forums.meteor.com/t/the-state-of-velocity-and-testing-in-meteor/15084/9" data-href="https://forums.meteor.com/t/the-state-of-velocity-and-testing-in-meteor/15084/9" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Chimp was the direction MDG was currently heading towards</a>. But I spent some time understanding how to setup my tests from scratch, because I had to discover several tools and langages at once:</p><ul class="postList"><li name="62d8" id="62d8" class="graf graf--li graf-after--p"><a href="https://github.com/xolvio/chimp" data-href="https://github.com/xolvio/chimp" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Chimp</a> (the test runner),</li><li name="570f" id="570f" class="graf graf--li graf-after--li"><a href="https://cucumber.io" data-href="https://cucumber.io" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Cucumber</a> (the langage for writing test scenarios),</li><li name="b066" id="b066" class="graf graf--li graf-after--li">and <a href="http://jasmine.github.io/2.3/introduction.html#section-Expectations" data-href="http://jasmine.github.io/2.3/introduction.html#section-Expectations" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Jasmine</a> (the the langage for expressing test validation criteria).</li></ul><p name="7209" id="7209" class="graf graf--p graf-after--li">Moreover, these tools are generic, and Meteor.js brings additional objects and methods that can (or must) be used from Chimp and Cucumber.</p><h4 name="5a77" id="5a77" class="graf graf--h4 graf-after--p">The setup process</h4><p name="e335" id="e335" class="graf graf--p graf-after--h4">As explained on <a href="https://chimp.readme.io/docs/tutorial" data-href="https://chimp.readme.io/docs/tutorial" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">their documentation</a>, I installed Chimp globally using `npm install -g chimp` so that I could run the `chimp` command from anywhere. On the first run, Chimp installed webdriver (or scelenium, I don’t remember).</p><p name="b7ec" id="b7ec" class="graf graf--p graf-after--p">But, the first run concluded with a weird error: `Directory features does not exist. Not running`, and I had not found any mention of that directory (or error) in Chimp’s documentation.</p><p name="f4de" id="f4de" class="graf graf--p graf-after--p">I had to find in <a href="https://chimp.readme.io/docs/tutorial" data-href="https://chimp.readme.io/docs/tutorial" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">this tutorial</a> that tests had to be described in a `features` directory, using the <a href="https://cucumber.io/docs/reference#gherkin" data-href="https://cucumber.io/docs/reference#gherkin" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Gherkin langage</a>. So I added a `./tests/features/test.feature` file in my Meteor.js project, to see what would happen:</p><pre name="d7d6" id="d7d6" class="graf graf--pre graf-after--p">@watch<br>Feature: Search the Web<br><br>  As a human<br>  I want to search the web<br>  So I can find information<br><br>  Scenario: Search for Xolv.io<br>    Given I have visited Google<br>    When I search for &quot;Xolv.io&quot;<br>    Then I see &quot;Xolv.io&quot;</pre><p name="1907" id="1907" class="graf graf--p graf-after--pre">As Chimp was running in `watch` mode, it provided me with some code in the console, to help me implement the corresponding tests:</p><pre name="cc0f" id="cc0f" class="graf graf--pre graf-after--p">You can implement step definitions for undefined steps with these snippets:<br><br>this.Given(/^I have visited Google$/, function () {<br>  // Write the automation code here<br>  pending();<br>});<br><br>this.When(/^I search for &quot;([^&quot;]*)&quot;$/, function () {<br>  // Write the automation code here<br>  pending();<br>});<br><br>this.Then(/^I see &quot;([^&quot;]*)&quot;$/, function () {<br>  // Write the automation code here<br>  pending();<br>});</pre><p name="b7a0" id="b7a0" class="graf graf--p graf-after--pre">So, by following the tutorial, and reading <a href="https://github.com/cucumber/cucumber-js" data-href="https://github.com/cucumber/cucumber-js" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Cucumber-js’ docs</a>, I wrote the following `./tests/features/support/defs.js` file:</p><pre name="5c66" id="5c66" class="graf graf--pre graf-after--p">module.exports = function() {</pre><pre name="0b38" id="0b38" class="graf graf--pre graf-after--pre">  // Hooks</pre><pre name="95ab" id="95ab" class="graf graf--pre graf-after--pre">  // this function is run before testing each scenario.<br>  // it makes sure that we&#39;re using a test (i.e. empty) database.<br>  this.Before(function(scenario) {<br>    console.log(&#39;meteor running on:&#39;,<br>      server._original.host + ‘:’ + server._original.port);<br>    console.log(‘about to test:’, scenario.getName());<br>    var result = server.execute(function() {<br>      console.log(‘counting...’); // displays in Meteor&#39;s console<br>      return Meteor.users.find().fetch().length;<br>    });<br>    expect(result).toEqual(0);<br>  });</pre><pre name="357c" id="357c" class="graf graf--pre graf-after--pre">  // this function is run after testing each scenario  <br>  this.After(function(scenario) {<br>    // TODO: clean DB, to prevent side-effects between tests<br>  });</pre><pre name="c607" id="c607" class="graf graf--pre graf-after--pre">  // Tests</pre><pre name="bd27" id="bd27" class="graf graf--pre graf-after--pre">  this.Given(/^I have visited Google$/, function () {<br>    browser.url(&#39;http://google.com&#39;); // ...or localhost:3000 ^^<br>    // browser = WebdriverIO instance<br>  });<br><br>  this.When(/^I search for &quot;([^&quot;]*)&quot;$/, function (searchTerm) {<br>    browser.setValue(&#39;input[name=&quot;q&quot;]&#39;, searchTerm);<br>    browser.keys([&#39;Enter&#39;]);<br>  });<br><br>  this.Then(/^I see &quot;([^&quot;]*)&quot;$/, function (link) {<br>    browser.waitForExist(&#39;a=&#39; + link);<br>  });</pre><pre name="0dc2" id="0dc2" class="graf graf--pre graf-after--pre">  // I also added this test, based on another example:<br>  this.Then(/^They see the title &quot;([^&quot;]*)&quot;$/, function(title) {<br>    browser.saveScreenshot(&quot;screenshot.png&quot;);<br>    expect(browser.getTitle()).toEqual(title); // Jasmine Expect<br>  });  <br>}</pre><p name="acec" id="acec" class="graf graf--p graf-after--pre">When both files are correct, and Chimp is running in watch mode from the ./tests directory, it’s working awesomely!</p><ul class="postList"><li name="1a65" id="1a65" class="graf graf--li graf-after--p">Chimp opens a Chrome browser, and we can see tests running in that window, like if a real human user was doing it!</li><li name="c4f1" id="c4f1" class="graf graf--li graf-after--li">Test results display in Chimp’s console.</li></ul><p name="e639" id="e639" class="graf graf--p graf-after--li">But my `Before` hook prevents the tests from actually running, because the database is not empty. Indeed, as advised by <a href="https://chimp.readme.io/docs/getting-started-with-meteor-cucumber" data-href="https://chimp.readme.io/docs/getting-started-with-meteor-cucumber" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Chimp’s Meteor tutorial</a>, I had launched Chimp that way:</p><pre name="733b" id="733b" class="graf graf--pre graf-after--p">chimp --ddp=<a href="http://localhost:3000" data-href="http://localhost:3000" class="markup--anchor markup--pre-anchor" rel="nofollow" target="_blank">http://localhost:3000</a> --watch</pre><p name="32a1" id="32a1" class="graf graf--p graf-after--pre">…which connects to my development Meteor.js instance, and thus, to my development database (containing data: users, etc…).</p><p name="7174" id="7174" class="graf graf--p graf-after--p">I found on a forum that it was ok to run two Meteor instances:</p><ul class="postList"><li name="986f" id="986f" class="graf graf--li graf-after--p">one for development, by just running the `meteor` command;</li><li name="9702" id="9702" class="graf graf--li graf-after--li">and one for testing, by specifying different HTTP and DB ports.</li></ul><p name="47e7" id="47e7" class="graf graf--p graf-after--li">So I ended up writing the following `./tests.sh` script that I use today:</p><pre name="bcd7" id="bcd7" class="graf graf--pre graf-after--p">#!/bin/bash</pre><pre name="c92a" id="c92a" class="graf graf--pre graf-after--pre"># Startup Chimp testing instance<br>MONGO_PORT=3001<br>METEOR_PORT=3100</pre><pre name="3138" id="3138" class="graf graf--pre graf-after--pre">echo After METEOR IS READY, run: chimp --path=tests \<br>     --ddp=<a href="http://localhost:$METEOR_PORT" data-href="http://localhost:$METEOR_PORT" class="markup--anchor markup--pre-anchor" rel="nofollow noopener" target="_blank">http://localhost:$METEOR_PORT</a> --watch</pre><pre name="ad68" id="ad68" class="graf graf--pre graf-after--pre">bash -c &quot;MONGO_URL=mongodb://localhost:$MONGO_PORT/chimp_db \<br>     meteor --port $METEOR_PORT $@&quot;</pre><p name="36bb" id="36bb" class="graf graf--p graf-after--pre">When I’m working on my project:</p><ul class="postList"><li name="8ab2" id="8ab2" class="graf graf--li graf-after--p">I run `meteor` to start the development instance, as usual;</li><li name="a35b" id="a35b" class="graf graf--li graf-after--li">then I run `./tests.sh` in another console, to start the testing instance.</li><li name="0024" id="0024" class="graf graf--li graf-after--li">When, the testing instance is running, I copy-paste the chimp command printed by my script, to yet another console.</li></ul><p name="12b9" id="12b9" class="graf graf--p graf-after--li">That way, I’m able to develop as usual from localhost:3000, using my development database; and to run tests in the background, on a dedicated (clean) database.</p><h4 name="c53b" id="c53b" class="graf graf--h4 graf-after--p">In a nutshell (tl;dr)</h4><p name="6d05" id="6d05" class="graf graf--p graf-after--h4">If you want to add end-to-end tests using Chimp+Cucumber+Jasmine to your Meteor.js project:</p><ul class="postList"><li name="cc4a" id="cc4a" class="graf graf--li graf-after--p">Install Chimp;</li><li name="b3c8" id="b3c8" class="graf graf--li graf-after--li">Copy-paste the code blocks provided above, into the corresponding files;</li><li name="8bdd" id="8bdd" class="graf graf--li graf-after--li">Run ./tests.sh to start your testing Meteor instance, then the printed Chimp command to actually run the tests.</li><li name="a4c2" id="a4c2" class="graf graf--li graf-after--li">Add feature descriptions using Cucumber’s <a href="https://cucumber.io/docs/reference#gherkin" data-href="https://cucumber.io/docs/reference#gherkin" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Gherkin langage</a>.</li><li name="1be6" id="1be6" class="graf graf--li graf-after--li graf--trailing">Add test definitions using <a href="https://github.com/cucumber/cucumber-js" data-href="https://github.com/cucumber/cucumber-js" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Cucumber-js’ doc</a>, the <a href="http://webdriver.io/api.html" data-href="http://webdriver.io/api.html" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">browser object API</a>, Meteor’s <a href="https://chimp.readme.io/docs/getting-started-with-meteor-cucumber" data-href="https://chimp.readme.io/docs/getting-started-with-meteor-cucumber" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">server and client objects</a>, and <a href="http://jasmine.github.io/2.3/introduction.html#section-Expectations" data-href="http://jasmine.github.io/2.3/introduction.html#section-Expectations" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Jasmine’s expectations</a>.</li></ul></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@adrienjoly" class="p-author h-card">Adrien Joly</a> on <a href="https://medium.com/p/4c2ba438c714"><time class="dt-published" datetime="2016-01-17T11:37:05.801Z">January 17, 2016</time></a>.</p><p><a href="https://medium.com/@adrienjoly/how-to-test-your-meteor-js-web-app-using-chimp-cucumber-and-jasmine-4c2ba438c714" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on February 10, 2020.</p></footer></article></body></html>